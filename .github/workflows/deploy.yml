
name: build-and-deploy

on:
  push:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy NextJS App to DigitalOcean
      uses: appleboy/ssh-action@v0.1.4
      env:
        mypw: ${{ secrets.SSH_USERNAME_PASSWORD }}
      with: 
        host:     ${{ secrets.SSH_HOST }}
        key:      ${{ secrets.SSH_KEY }}
        username: ${{ secrets.SSH_USERNAME }}
      
        script: |
          echo "$mypw" | sudo -S rm -r nextjs-portfolio
          git clone git@github.com:rileyhgrant/nextjs-portfolio.git nextjs-portfolio
          cd nextjs-portfolio
          npm install
          npm run build
          pm2 restart nextjs-portfolio
          echo "Deployment successful."
          
